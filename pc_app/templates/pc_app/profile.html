{% extends 'pc_app/base.html' %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
  .link-container {
    display: inline-block;
    margin-right: 20px;
    /* Adjust the margin as needed for spacing */
  }

  .profile-picture-container {
    width: 200px;
    /* Set the desired width */
    height: 200px;
    /* Set the desired height */
    overflow: hidden;
    /* Hide overflow to maintain the round shape */
    border-radius: 50%;
    /* Make it round */
    cursor: pointer;
  }

  .profile-picture {
    width: 100%;
    /* Set the image width to fill the container */
    height: 100%;
    /* Set the image height to fill the container */
    object-fit: cover;
    /* Maintain the image aspect ratio */
  }
</style>

<div style="padding: 20px; max-width: max-content; margin-top: 20px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px;">
<h1>Profile</h1>

<div class="link-container">
  <p><a href="{% url 'completed_order' %}">Completed Orders</a></p>
</div>
<div class="link-container">
  <p><a href="{% url 'ongoing_order' %}">Ongoing Orders</a></p>
</div>

<div class="profile-picture-container">
  <label for="profile-picture-input">
    {% if user.profile.profile_picture %}
    {% if user.profile.profile_picture == 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' %}
    <img class="profile-picture" src="{{ user.profile.profile_picture }}" alt="PFP">
    {% else %}
    <img class="profile-picture" src="{{ user.profile.profile_picture.url }}" alt="PFP">
    {% endif %}
    {% else %}
    <img class="profile-picture"
      src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" alt="Default PFP">
    {% endif %}
  </label>
  <input type="file" id="profile-picture-input" style="display: none;">
</div>

<p>Username: {{ user.username }}</p>
<p>Email: {{ user.email }}</p>
<p>Phone num: <span id="phone-number">{{ user.profile.phone_number }}</span>
  <a id="edit-phone-number" style="text-decoration: underline;"><i class="fas fa-edit"></i></a>
</p>

<form method="post" id="phone-number-update-form" style="display: none;">
  <h4>Update Phone No.</h4>
  {% csrf_token %}
  {{ phone_number_form.as_p }}
  <button type="submit" id="update-phone-no">Update</button>
</form>


<h4>Change Password</h4>
<a id="edit-password" style="text-decoration: underline;">
  <i class="fas fa-edit"></i></a>
<!-- Display success and error messages -->
{% if messages %}
<ul class="messages">
  {% for message in messages %}
  <li{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}


<form method="post" id="password-change-form" style="display: none;"> <!-- action="{% url 'change_password' %}" -->
  {% csrf_token %}
  {{ password_change_form.as_p }}
  <button type="submit" id="password-change-butt">Change Password</button>
</form>

</div>

<style>
  #edit-phone-number:hover {
    color: rgb(57, 108, 203);
  }

  #edit-password:hover {
    color: rgb(57, 108, 203);
  }
</style>

<script>
  document.getElementById('update-phone-no').addEventListener('click', function () {
    // Display an alert when the button is pressed
    alert('Phone number updated successfully!');
  });

  // document.getElementById('password-change-butt').addEventListener('click', function () {
  //   // Display an alert when the button is pressed
  //   alert('Password changed successfully!');
  // });


  document.getElementById("profile-picture-input").addEventListener("change", function () {
    const fileInput = this;
    if (fileInput.files && fileInput.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const profilePicture = document.querySelector(".profile-picture");
        profilePicture.src = e.target.result;

        // Send the image to the server via AJAX
        const formData = new FormData();
        formData.append("profile_picture", fileInput.files[0]);
        fetch("{% url 'update_profile_picture' %}", {
          method: "POST",
          body: formData,
          headers: {
            "X-CSRFToken": "{{ csrf_token }}"
          },
        })
          .then(response => response.json())
          .then(data => {
            if (data.message) {
              // Display the success message
              const messageDiv = document.createElement("div");
              messageDiv.classList.add("success-message");
              messageDiv.textContent = data.message;
              document.body.appendChild(messageDiv);

              // Remove the message after a few seconds
              setTimeout(() => {
                document.body.removeChild(messageDiv);
              }, 3000);
            }
          })
          .catch(error => {
            console.error("Error updating profile picture:", error);
          });
      };
      reader.readAsDataURL(fileInput.files[0]);
    }
  });


  //Phone number update
  // JavaScript to toggle the visibility of password change and phone number update forms
  const passwordChangeForm = document.getElementById('password-change-form');
  const phoneNumberUpdateForm = document.getElementById('phone-number-update-form');
  const phoneNumberDisplay = document.getElementById('phone-number');
  const editPhoneNumberButton = document.getElementById('edit-phone-number');
  const editPasswordButton = document.getElementById('edit-password');

  // // Initially, hide both forms
  // passwordChangeForm.style.display = 'none';
  // phoneNumberUpdateForm.style.display = 'none';

  // Show the password change form when it's requested
  function showPasswordChangeForm() {
    passwordChangeForm.style.display = 'block';
    phoneNumberUpdateForm.style.display = 'none';
  }

  // Show the phone number update form when it's requested
  function showPhoneNumberUpdateForm() {
    phoneNumberUpdateForm.style.display = 'block';
    passwordChangeForm.style.display = 'none';
  }

  // Attach click event listeners to the Edit button
  editPhoneNumberButton.addEventListener('click', showPhoneNumberUpdateForm);
  editPasswordButton.addEventListener('click', showPasswordChangeForm);

  window.addEventListener("message", function (event) {
    if (event.data === "chatbot-closed") {
      chatbotFrame.style.display = "none";
      openChatbotButton.style.display = "block";
    }
  });
</script>


{% endblock %}