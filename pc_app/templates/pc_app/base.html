<!-- base.html -->
<!DOCTYPE html>
<html>

<head>
    <title>Intelligent PC Builder</title>
    {% load static %}
    <script src="https://code.jquery.com/jquery-2.2.0.min.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/slick.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/slick-theme.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/skdslider.css' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

</head>

<style>
    .component-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        /* Add space between rows (adjust as needed) */
    }

    .component-box {
        flex: 0 0 calc(20% - 10px);
        /* Set the width of each CPU element (adjust as needed) */
        margin-right: 10px;
        /* Add spacing between CPU elements (adjust as needed) */
        border: 1px solid #ccc;
        padding: 10px;
    }

    .component-box:hover {
        background-color: #f0f0f0;
        /* Change the background color on hover (adjust as needed) */
    }

    /* Slide-out bar */
    .slide-menu {
        position: fixed;
        top: 0;
        right: -400px;
        /* Start off-screen */
        width: 400px;
        height: 100%;
        background-color: white;
        box-shadow: -5px 0px 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        /* Set a high z-index value */
        transition: right 0.3s ease-in-out;
    }

    .slide-menu.open {
        right: 0;
        /* Slide in when open */
    }

    .slide-button {
        position: fixed;
        top: 20px;
        right: -50px;
        /* Changed from -50px to 20px */
        padding: 10px;
        background-color: #333;
        color: white;
        border: none;
        z-index: 1000;
        /* Set a high z-index value */
        cursor: pointer;
        transition: right 0.3s ease-in-out;
    }

    .slide-button.open {
        right: 0px;
        /* Changed from 0 to 300px */
    }
</style>

<body>
    <div class="pre_loader gray_bg text-center">
        <div class="loader">
            <div>
                <div>
                    <div>
                        <div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% include 'pc_app/bin/header.html' %}

    {% block headermenu %} {% endblock %}

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-2">
                {% include 'pc_app/bin/sidebar.html' %}
            </div>

            <div class="col-sm-10">
                {% block container %}{% endblock %}
                {% block content %}{% endblock %}
            </div>

        </div>
    </div>

    <div id="snackbar"></div>

    <!-- Customize PC Build Button -->
    <div id="slideOutMenu" class="slide-menu">
        {% include 'pc_app/bin/customize.html' %}
    </div>

    <button id="slideToggleButton" class="slide-button" onclick="toggleSlideMenu()">&gt;</button>


    <footer>{% include 'pc_app/bin/footer.html' %}</footer>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"
        type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-touchspin/4.2.5/jquery.bootstrap-touchspin.js"
        type="text/javascript"></script>
    <script src="{% static 'js/skdslider.min.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"
        type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Readmore.js/2.2.1/readmore.js" type="text/javascript"></script>
    <script src="https://www.google-analytics.com/analytics.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <script src="{% static 'js/main.js' %}"></script>
    {% block scripts %}{% endblock %}
</body>

</html>


<script>
    var totalPrice = 0.0;
    var storedCPUPrice=0, storedGPUPrice=0, storedMotherboardPrice=0;

    // Function to calculate and display the total price
    function displayTotalPrice() {
        const storedCPUPrice = localStorage.getItem('selectedCPUPrice');
        const storedGPUPrice = localStorage.getItem('selectedGPUPrice');
        const storedMotherboardPrice = localStorage.getItem('selectedMotherboardPrice');

        // Check if stored prices exist, otherwise set them to 0
        const parsedCPUPrice = parseFloat(storedCPUPrice) || 0;
        const parsedGPUPrice = parseFloat(storedGPUPrice) || 0;
        const parsedMotherboardPrice = parseFloat(storedMotherboardPrice) || 0;
        
        totalPrice = 1 + parsedCPUPrice + parsedGPUPrice + parsedMotherboardPrice;
        document.getElementById('totalPrice').innerText = `Total Price: RM${totalPrice.toFixed(2)}`;
        localStorage.setItem('totalPrice', totalPrice);
    }


    document.addEventListener('DOMContentLoaded', function () {
        var menu = document.getElementById('slideOutMenu');
        var button = document.getElementById('slideToggleButton');

        // Open the menu on page load
        menu.classList.add('open');
        button.classList.add('open');

        // Toggle the menu when the button is clicked
        button.addEventListener('click', function () {
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                button.classList.remove('open');
            } else {
                menu.classList.add('open');
                button.classList.add('open');
            }
        });
    });

    // Get the CSRF token from the cookie
    const csrftoken = Cookies.get('csrftoken');

    function selectComponent(componentType, componentId) {
        var menu = document.getElementById('slideOutMenu');
        var button = document.getElementById('slideToggleButton');

        menu.classList.add('open');
        button.classList.add('open');

        if (componentType === 'cpu') {
            // Fetch CPU information using AJAX
            var cpuXhr = new XMLHttpRequest();
            cpuXhr.open("GET", `/get_cpu_info/${componentId}`);
            cpuXhr.onreadystatechange = function () {
                if (cpuXhr.readyState === XMLHttpRequest.DONE && cpuXhr.status === 200) {
                    var cpuInfo = JSON.parse(cpuXhr.responseText);
                    localStorage.setItem('selectedCPUID', componentId); //To favourite the CPU
                    localStorage.setItem('selectedCPU', `${cpuInfo.name} - RM ${cpuInfo.price}`);
                    document.getElementById('selectedCPU').innerText = `${cpuInfo.name} - RM ${cpuInfo.price}`;

                    localStorage.setItem('selectedCPUPrice', parseFloat(`${cpuInfo.price}`));
                    //document.getElementById('totalPrice').innerText = `CPU Price: ${cpuPrice.toFixed(2)}`;
                    // Calculate and display total price
                    displayTotalPrice();

                    alert(`CPU: ${cpuInfo.name} selected for customization!`);
                }
            };
            cpuXhr.send();
        } else if (componentType === 'gpu') {
            // Fetch GPU information using AJAX
            var gpuXhr = new XMLHttpRequest();
            gpuXhr.open("GET", `/get_gpu_info/${componentId}`);
            gpuXhr.onreadystatechange = function () {
                if (gpuXhr.readyState === XMLHttpRequest.DONE && gpuXhr.status === 200) {
                    var gpuInfo = JSON.parse(gpuXhr.responseText);
                    localStorage.setItem('selectedGPUID', componentId); //To favourite the GPU
                    localStorage.setItem('selectedGPU', `${gpuInfo.chipset} - RM ${gpuInfo.price}`);
                    document.getElementById('selectedGPU').innerText = `${gpuInfo.chipset} - RM ${gpuInfo.price}`;

                    alert(`GPU: ${gpuInfo.chipset} selected for customization!`);

                    // Update GPU price
                    localStorage.setItem('selectedGPUPrice', parseFloat(`${gpuInfo.price}`));
                    selectedGPUPrice = parseFloat(`${gpuInfo.price}`)
                    // Calculate and display total price
                    displayTotalPrice();
                }
            };
            gpuXhr.send();
        } else if (componentType === 'motherboard') {
            // Fetch Motherboard information using AJAX
            var gpuXhr = new XMLHttpRequest();
            gpuXhr.open("GET", `/get_mboard_info/${componentId}`);
            gpuXhr.onreadystatechange = function () {
                if (gpuXhr.readyState === XMLHttpRequest.DONE && gpuXhr.status === 200) {
                    var mboard_info = JSON.parse(gpuXhr.responseText);
                    localStorage.setItem('selectedMotherboardID', componentId); //To favourite the GPU
                    localStorage.setItem('selectedMotherboard', `${mboard_info.name} - RM ${mboard_info.price}`);
                    document.getElementById('selectedMotherboard').innerText = `${mboard_info.name} - RM ${mboard_info.price}`;

                    alert(`GPU: ${mboard_info.name} selected for customization!`);

                    // Update Motherboard price
                    localStorage.setItem('selectedMotherboardPrice', parseFloat(`${mboard_info.price}`));
                    selectedMotherboardPrice = parseFloat(`${mboard_info.price}`)
                    // Calculate and display total price
                    displayTotalPrice();
                }
            };
            gpuXhr.send();
        }
        // Add more else-if conditions for other components if needed
    }

    // Retrieve and display previously selected components on page load
    window.onload = function () {
        const storedCPU = localStorage.getItem('selectedCPU');
        const storedGPU = localStorage.getItem('selectedGPU');
        const storedMotherboard = localStorage.getItem('selectedMotherboard');
        const storedtotalPrice = localStorage.getItem('totalPrice');

        document.getElementById('selectedCPU').innerText = storedCPU || '';
        document.getElementById('selectedGPU').innerText = storedGPU || '';
        document.getElementById('selectedMotherboard').innerText = storedMotherboard || '';
        document.getElementById('totalPrice').innerText = `Total Price: RM${storedtotalPrice}`;
    };

    function clearSelections() {
        localStorage.removeItem('selectedCPU');
        localStorage.removeItem('selectedGPU');
        localStorage.removeItem('selectedCPUID');
        localStorage.removeItem('selectedGPUID');
        localStorage.removeItem('totalPrice');
        // Add similar lines for other components if needed
        document.getElementById('selectedCPU').innerText = '';
        document.getElementById('selectedGPU').innerText = '';
        document.getElementById('selectedCPUID').innerText = '';
        document.getElementById('selectedGPUID').innerText = '';
        document.getElementById('totalPrice').innerText = '';
    }

    //Storing to database
    function toggleFavorite() {
        const selectedCPUID = localStorage.getItem('selectedCPUID');
        const selectedGPUID = localStorage.getItem('selectedGPUID');
        const selectedMotherboardID = localStorage.getItem('selectedMotherboardID');

        if (selectedCPUID && selectedGPUID && selectedMotherboardID) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/toggle_favorite/', true);
            xhr.setRequestHeader('X-CSRFToken', csrftoken); // Set the CSRF token in the request header
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        alert('PC build saved successfully!');
                        window.location.href = '/favorited_builds/';
                    } else {
                        alert('Failed to save PC build.');
                    }
                }
            };
            xhr.send(JSON.stringify({ cpu_id: selectedCPUID, gpu_id: selectedGPUID, mboard_id: selectedMotherboardID }));
        } else {
            alert('Please select all components before saving!');
        }
    }

    function addToCart() {
        var selectedCPUID = localStorage.getItem('selectedCPUID');
        var selectedGPUID = localStorage.getItem('selectedGPUID');
        var selectedMotherboardID = localStorage.getItem('selectedMotherboardID');

        if (selectedCPUID && selectedGPUID && selectedMotherboardID) {
            // Send selected component IDs to Django view
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/add_to_cart/', true);
            xhr.setRequestHeader('X-CSRFToken', csrftoken);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            alert('Components added to cart successfully!');
                            window.location.href = '/cart_items/';
                        } else {
                            alert('Failed to add components to cart.');
                        }
                    } else {
                        alert('Failed to communicate with the server.');
                    }
                }
            };
            xhr.send(JSON.stringify({ cpu_id: selectedCPUID, gpu_id: selectedGPUID, mboard_id: selectedMotherboardID }));
        } else {
            alert('Please select all components before adding to cart!');
        }

        // Send the selected component IDs to the server
        var formData = new FormData();
        formData.append('selectedCPUID', selectedCPUID);
        formData.append('selectedGPUID', selectedGPUID);
        formData.append('selectedMotherboardID', selectedMotherboardID);
        xhr.send(formData);
    }


</script>