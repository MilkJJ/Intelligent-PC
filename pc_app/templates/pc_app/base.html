<!-- base.html -->
<!DOCTYPE html>
<html>

<head>
    <title>Intelligent PC Builder</title>
    {% load static %}
    <script src="https://code.jquery.com/jquery-2.2.0.min.js" type="text/javascript"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var rateOrderButton = document.getElementById('rate-button');

            rateOrderButton.addEventListener('click', function (e) {
                if (!confirm('Are you sure to rate this component?')) {
                    e.preventDefault(); // Cancel the form submission
                } else {
                    alert('Successfully rated this component!');
                }
            });
        });

        function updateBackgroundColor(spanId, tdId) {
            var span = document.getElementById(spanId);
            var td = document.getElementById(tdId);

            var storedCase = localStorage.getItem(spanId);

            if (storedCase === null || storedCase === undefined) {
                td.classList.add('red-background');
            }
            // else {
            //     td.classList.add('green-background');
            // }
        }

        function updateBackground(spanId, tdId) {
            var td = document.getElementById(tdId);
            td.classList.remove('red-background');
        }

    </script>
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/slick.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/slick-theme.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/skdslider.css' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

</head>

<style>
    button.select-button {
        background-color: #333;
        color: #fff;
        border: none;
        cursor: pointer;
        padding: 7px 20px;
        border-radius: 5px;
        /* font-weight: bold; */
    }

    button.select-button:hover {
        background-color: #252438;
    }

    header {
        background-color: #333;
        color: #fff;
        text-align: center;
        padding: 1rem;
        max-width: 1100px;
    }

    .component-row {
        display: flex;
        /* justify-content: space-between; */
        margin-bottom: 30px;
    }

    .component-box {
        flex: 0 0 calc(20% - 10px);
        /* Set the width of each CPU element (adjust as needed) */
        margin-right: 10px;
        /* Add spacing between CPU elements (adjust as needed) */
        border: 1px solid #ccc;
        padding: 10px;
    }

    .component-box:hover {
        background-color: #f0f0f0;
        /* Change the background color on hover (adjust as needed) */
    }

    /* Slide-out bar */
    .slide-menu {
        position: fixed;
        top: 0;
        right: -600px;
        /* Customization Screen Size */
        width: 700px;
        height: 100%;
        background-color: white;
        box-shadow: -5px 0px 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        /* Set a high z-index value */
        transition: right 0.3s ease-in-out;
    }

    .slide-menu.open {
        right: 0;
        /* Slide in when open */
    }

    .slide-button {
        position: fixed;
        top: 20px;
        /* Button visiblility */
        right: -15px;
        padding: 10px;
        background-color: #e9921f;
        color: white;
        border: none;
        z-index: 1000;
        /* Set a high z-index value */
        cursor: pointer;
        transition: right 0.3s ease-in-out;
    }

    .slide-button.open {
        right: 10px;
        /* Changed from 0 to 300px */
    }

    .divider {
        height: 1px;
        /* Set the height of the line */
        background-color: #d5d5d5;
        /* Set the color of the line */
        margin: 20px 0;
        /* Adjust margin as needed */
        border: none;
        /* Remove any borders */
    }
</style>

<body>
    <div class="pre_loader gray_bg text-center">
        <div class="loader">
            <div>
                <div>
                    <div>
                        <div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% include 'pc_app/bin/header.html' %}

    {% block headermenu %} {% endblock %}

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-2">
                {% include 'pc_app/bin/sidebar.html' %}
            </div>

            <div class="col-sm-10">
                {% block container %}{% endblock %}
                {% block content %}{% endblock %}
            </div>

        </div>
    </div>

    <div id="snackbar"></div>

    <!-- Customize PC Build Button -->
    <div id="slideOutMenu" class="slide-menu">
        {% include 'pc_app/bin/customize.html' %}
    </div>

    <button id="slideToggleButton" class="slide-button" onclick="toggleSlideMenu()"><span class="fas fa-bars"></span>
        View Configuration</button>


    <footer>{% include 'pc_app/bin/footer.html' %}</footer>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"
        type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-touchspin/4.2.5/jquery.bootstrap-touchspin.js"
        type="text/javascript"></script>
    <script src="{% static 'js/skdslider.min.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"
        type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Readmore.js/2.2.1/readmore.js" type="text/javascript"></script>
    <script src="https://www.google-analytics.com/analytics.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <script src="{% static 'js/main.js' %}"></script>
    {% block scripts %}{% endblock %}
</body>

</html>


<script>
    // Function to calculate and display the total price
    function displayTotalPrice() {
        const storedCPUPrice = localStorage.getItem('selectedCPUPrice');
        const storedGPUPrice = localStorage.getItem('selectedGPUPrice');
        const storedMotherboardPrice = localStorage.getItem('selectedMotherboardPrice');
        const storedRAMPrice = localStorage.getItem('selectedRAMPrice');
        const storedPSUPrice = localStorage.getItem('selectedPSUPrice');
        const storedStoragePrice = localStorage.getItem('selectedStoragePrice');
        const storedCasePrice = localStorage.getItem('selectedCasePrice');

        // Check if stored prices exist, otherwise set them to 0
        const parsedCPUPrice = parseFloat(storedCPUPrice) || 0;
        const parsedGPUPrice = parseFloat(storedGPUPrice) || 0;
        const parsedMotherboardPrice = parseFloat(storedMotherboardPrice) || 0;
        const parsedRAMPrice = parseFloat(storedRAMPrice) || 0;
        const parsedPSUPrice = parseFloat(storedPSUPrice) || 0;
        const parsedStoragePrice = parseFloat(storedStoragePrice) || 0;
        const parsedCasePrice = parseFloat(storedCasePrice) || 0;

        totalPrice = 0 + parsedCPUPrice + parsedGPUPrice + parsedMotherboardPrice + parsedRAMPrice + parsedPSUPrice + parsedStoragePrice + parsedCasePrice;
        document.getElementById('totalPrice').innerText = `$${totalPrice.toFixed(2)}`;
        localStorage.setItem('totalPrice', totalPrice.toFixed(2));
    }

    document.addEventListener('DOMContentLoaded', function () {
        var menu = document.getElementById('slideOutMenu');
        var button = document.getElementById('slideToggleButton');

        // // Open the menu on page load
        // menu.classList.add('open');
        // button.classList.add('open');

        // Toggle the menu when the button is clicked
        button.addEventListener('click', function () {
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                button.classList.remove('open');
            } else {
                menu.classList.add('open');
                button.classList.add('open');
            }
        });
    });

    // Get the CSRF token from the cookie
    const csrftoken = Cookies.get('csrftoken');

    function selectComponent(componentType, componentId, copyAll = false) {
        var menu = document.getElementById('slideOutMenu');
        var button = document.getElementById('slideToggleButton');

        menu.classList.add('open');
        button.classList.add('open');

        if (componentType === 'cpu') {
            // Fetch CPU information using AJAX
            var compXhr = new XMLHttpRequest();
            compXhr.open("GET", `/get_cpu_info/${componentId}`);
            compXhr.onreadystatechange = function () {
                if (compXhr.readyState === XMLHttpRequest.DONE && compXhr.status === 200) {
                    var cpuInfo = JSON.parse(compXhr.responseText);
                    localStorage.setItem('selectedCPUID', componentId); //To favourite the CPU
                    localStorage.setItem('selectedCPU', `${cpuInfo.name} - $${cpuInfo.price}`);
                    updateBackground('selectedCPU', 'cpuRow');

                    document.getElementById('selectedCPU').innerText = `${cpuInfo.name} - $${cpuInfo.price}`;

                    localStorage.setItem('selectedCPUPrice', parseFloat(`${cpuInfo.price}`));
                    //document.getElementById('totalPrice').innerText = `CPU Price: ${cpuPrice.toFixed(2)}`;
                    // Calculate and display total price
                    displayTotalPrice();

                    if (copyAll == false) {
                        alert(`CPU: ${cpuInfo.name} selected for customization!`);
                    } else {
                        alert(`Build has been selected for Configuration!`);
                    }
                }
            };
            compXhr.send();
        } else if (componentType === 'gpu') {
            var compXhr = new XMLHttpRequest();
            compXhr.open("GET", `/get_gpu_info/${componentId}`);
            compXhr.onreadystatechange = function () {
                if (compXhr.readyState === XMLHttpRequest.DONE && compXhr.status === 200) {
                    var gpuInfo = JSON.parse(compXhr.responseText);
                    localStorage.setItem('selectedGPUID', componentId); //To favourite the GPU
                    localStorage.setItem('selectedGPU', `${gpuInfo.name} - ${gpuInfo.chipset} - $${gpuInfo.price}`);
                    updateBackground('selectedGPU', 'gpuRow');

                    document.getElementById('selectedGPU').innerText = `${gpuInfo.name} - ${gpuInfo.chipset} - $${gpuInfo.price}`;

                    if (copyAll == false) {
                        alert(`GPU: ${gpuInfo.chipset} selected for customization!`);
                    }

                    // Update GPU price
                    localStorage.setItem('selectedGPUPrice', parseFloat(`${gpuInfo.price}`));
                    selectedGPUPrice = parseFloat(`${gpuInfo.price}`)
                    // Calculate and display total price
                    displayTotalPrice();
                }
            };
            compXhr.send();
        } else if (componentType === 'motherboard') {
            // Fetch Motherboard information using AJAX
            var compXhr = new XMLHttpRequest();
            compXhr.open("GET", `/get_mboard_info/${componentId}`);
            compXhr.onreadystatechange = function () {
                if (compXhr.readyState === XMLHttpRequest.DONE && compXhr.status === 200) {
                    var mboard_info = JSON.parse(compXhr.responseText);
                    localStorage.setItem('selectedMotherboardID', componentId); //To favourite the GPU
                    localStorage.setItem('selectedMotherboard', `${mboard_info.name} - $${mboard_info.price}`);
                    document.getElementById('selectedMotherboard').innerText = `${mboard_info.name} - $${mboard_info.price}`;
                    updateBackground('selectedMotherboard', 'motherboardRow');

                    if (copyAll == false) {
                        alert(`GPU: ${mboard_info.name} selected for customization!`);
                    }

                    // Update Motherboard price
                    localStorage.setItem('selectedMotherboardPrice', parseFloat(`${mboard_info.price}`));
                    selectedMotherboardPrice = parseFloat(`${mboard_info.price}`)
                    // Calculate and display total price
                    displayTotalPrice();
                }
            };
            compXhr.send();
        } else if (componentType === 'ram') {
            var compXhr = new XMLHttpRequest();
            compXhr.open("GET", `/get_ram_info/${componentId}`);

            compXhr.onreadystatechange = function () {
                if (compXhr.readyState === XMLHttpRequest.DONE && compXhr.status === 200) {
                    const ramInfo = JSON.parse(compXhr.responseText);

                    // Store the selected RAM ID and details in local storage
                    localStorage.setItem('selectedRAMID', componentId);
                    localStorage.setItem('selectedRAM', `${ramInfo.name} - $${ramInfo.price}`);
                    updateBackground('selectedRAM', 'ramRow');

                    // Update the displayed RAM selection
                    const selectedRAMElement = document.getElementById('selectedRAM');
                    selectedRAMElement.innerText = `${ramInfo.name} - $${ramInfo.price}`;

                    if (!copyAll) {
                        alert(`RAM: ${ramInfo.name} selected for customization!`);
                    }

                    // Update RAM price
                    localStorage.setItem('selectedRAMPrice', parseFloat(ramInfo.price));
                    selectedRAMPrice = parseFloat(ramInfo.price);

                    // Calculate and display the total price
                    displayTotalPrice();
                }
            };

            compXhr.send();
        } else if (componentType === 'psu') {
            var compXhr = new XMLHttpRequest();
            compXhr.open("GET", `/get_psu_info/${componentId}`);

            compXhr.onreadystatechange = function () {
                if (compXhr.readyState === XMLHttpRequest.DONE && compXhr.status === 200) {
                    const psuInfo = JSON.parse(compXhr.responseText);

                    // Store the selected PSU ID and details in local storage
                    localStorage.setItem('selectedPSUID', componentId);
                    localStorage.setItem('selectedPSU', `${psuInfo.name} - $${psuInfo.price}`);
                    updateBackground('selectedPSU', 'psuRow');

                    // Update the displayed PSU selection
                    const selectedPSUElement = document.getElementById('selectedPSU');
                    selectedPSUElement.innerText = `${psuInfo.name} - $${psuInfo.price}`;

                    if (!copyAll) {
                        alert(`Power Supply: ${psuInfo.name} selected for customization!`);
                    }

                    // Update PSU price
                    localStorage.setItem('selectedPSUPrice', parseFloat(psuInfo.price));
                    selectedPSUPrice = parseFloat(psuInfo.price);

                    // Calculate and display the total price
                    displayTotalPrice();
                }
            };

            compXhr.send();
        } else if (componentType === 'storage') {
            const compXhr = new XMLHttpRequest();
            compXhr.open("GET", `/get_storage_info/${componentId}`);

            compXhr.onreadystatechange = function () {
                if (compXhr.readyState === XMLHttpRequest.DONE && compXhr.status === 200) {
                    const storageInfo = JSON.parse(compXhr.responseText);

                    // Store the selected storage ID and details in local storage
                    localStorage.setItem('selectedStorageID', componentId);
                    localStorage.setItem('selectedStorage', `${storageInfo.name} - $${storageInfo.price}`);
                    updateBackground('selectedStorage', 'storageRow');

                    // Update the displayed storage selection
                    const selectedStorageElement = document.getElementById('selectedStorage');
                    selectedStorageElement.innerText = `${storageInfo.name} - $${storageInfo.price}`;

                    if (!copyAll) {
                        alert(`Storage: ${storageInfo.name} selected for customization!`);
                    }

                    // Update storage price
                    localStorage.setItem('selectedStoragePrice', parseFloat(storageInfo.price));
                    selectedStoragePrice = parseFloat(storageInfo.price);

                    // Calculate and display the total price
                    displayTotalPrice();
                }
            };

            compXhr.send();
        } else if (componentType === 'case') {
            const compXhr = new XMLHttpRequest();
            compXhr.open("GET", `/get_case_info/${componentId}`);

            compXhr.onreadystatechange = function () {
                if (compXhr.readyState === XMLHttpRequest.DONE && compXhr.status === 200) {
                    const caseInfo = JSON.parse(compXhr.responseText);

                    // Store the selected case ID and details in local storage
                    localStorage.setItem('selectedCaseID', componentId);
                    localStorage.setItem('selectedCase', `${caseInfo.name} - $${caseInfo.price}`);
                    updateBackground('selectedCase', 'caseRow');

                    // Update the displayed case selection
                    const selectedCaseElement = document.getElementById('selectedCase');
                    selectedCaseElement.innerText = `${caseInfo.name} - $${caseInfo.price}`;

                    if (!copyAll) {
                        alert(`PC Case: ${caseInfo.name} selected for customization!`);
                    }

                    // Update case price
                    localStorage.setItem('selectedCasePrice', parseFloat(caseInfo.price));
                    selectedCasePrice = parseFloat(caseInfo.price);

                    // Calculate and display the total price
                    displayTotalPrice();
                }
            };

            compXhr.send();
        } // Add more else-if conditions for other components if needed
    }

    // Retrieve and display previously selected components on page load
    window.onload = function () {
        const storedCPU = localStorage.getItem('selectedCPU');
        const storedGPU = localStorage.getItem('selectedGPU');
        const storedMotherboard = localStorage.getItem('selectedMotherboard');
        const storedRAM = localStorage.getItem('selectedRAM');
        const storedPSU = localStorage.getItem('selectedPSU');
        const storedStorage = localStorage.getItem('selectedStorage');
        const storedCase = localStorage.getItem('selectedCase');

        displayTotalPrice()
        const storedtotalPrice = localStorage.getItem('totalPrice');

        if (storedtotalPrice) {
            const totalPrice = parseFloat(storedtotalPrice);
        }
        else {
            const totalPrice = 0
        }

        document.getElementById('selectedCPU').innerText = storedCPU || '-';
        document.getElementById('selectedGPU').innerText = storedGPU || '-';
        document.getElementById('selectedMotherboard').innerText = storedMotherboard || '-';
        document.getElementById('selectedRAM').innerText = storedRAM || '-';
        document.getElementById('selectedPSU').innerText = storedPSU || '-';
        document.getElementById('selectedStorage').innerText = storedStorage || '-';
        document.getElementById('selectedCase').innerText = storedCase || '-';
        document.getElementById('totalPrice').innerText = `$${totalPrice}` || '$$';


        updateBackgroundColor('selectedCPU', 'cpuRow');
        updateBackgroundColor('selectedGPU', 'gpuRow');
        updateBackgroundColor('selectedMotherboard', 'motherboardRow');
        updateBackgroundColor('selectedRAM', 'ramRow');
        updateBackgroundColor('selectedPSU', 'psuRow');
        updateBackgroundColor('selectedStorage', 'storageRow');
        updateBackgroundColor('selectedCase', 'caseRow');

    };

    function clearSelections() {
        localStorage.removeItem('selectedCPU');
        localStorage.removeItem('selectedGPU');
        localStorage.removeItem('selectedMotherboard');
        localStorage.removeItem('selectedRAM');
        localStorage.removeItem('selectedPSU');
        localStorage.removeItem('selectedStorage');
        localStorage.removeItem('selectedCase');
        localStorage.removeItem('selectedCPUID');
        localStorage.removeItem('selectedGPUID');
        localStorage.removeItem('totalPrice');

        localStorage.removeItem('selectedCPUPrice');
        localStorage.removeItem('selectedGPUPrice');
        localStorage.removeItem('selectedMotherboardPrice');
        localStorage.removeItem('selectedRAMPrice');
        localStorage.removeItem('selectedPSUPrice');
        localStorage.removeItem('selectedStoragePrice');
        localStorage.removeItem('selectedCasePrice');
        localStorage.removeItem('selectedCPUIDPrice');
        localStorage.removeItem('selectedGPUIDPrice');

        document.getElementById('selectedCPU').innerText = '-';
        document.getElementById('selectedGPU').innerText = '-';
        document.getElementById('selectedMotherboard').innerText = '-';
        document.getElementById('selectedRAM').innerText = '-';
        document.getElementById('selectedPSU').innerText = '-';
        document.getElementById('selectedStorage').innerText = '-';
        document.getElementById('selectedCase').innerText = '-';
        document.getElementById('totalPrice').innerText = '$$';

        updateBackgroundColor('selectedCPU', 'cpuRow');
        updateBackgroundColor('selectedGPU', 'gpuRow');
        updateBackgroundColor('selectedMotherboard', 'motherboardRow');
        updateBackgroundColor('selectedRAM', 'ramRow');
        updateBackgroundColor('selectedPSU', 'psuRow');
        updateBackgroundColor('selectedStorage', 'storageRow');
        updateBackgroundColor('selectedCase', 'caseRow');
    }

    //Storing to database
    function toggleFavorite() {
        const selectedCPUID = localStorage.getItem('selectedCPUID');
        const selectedGPUID = localStorage.getItem('selectedGPUID');
        const selectedMotherboardID = localStorage.getItem('selectedMotherboardID');
        const selectedRAMID = localStorage.getItem('selectedRAMID');
        const selectedPSUID = localStorage.getItem('selectedPSUID');
        const selectedStorageID = localStorage.getItem('selectedStorageID');
        const selectedCaseID = localStorage.getItem('selectedCaseID');

        if (selectedCPUID && selectedGPUID && selectedMotherboardID && selectedRAMID && selectedPSUID && selectedStorageID && selectedCaseID) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/toggle_favorite/', true);
            xhr.setRequestHeader('X-CSRFToken', csrftoken); // Set the CSRF token in the request header
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        alert('PC build has been saved successfully!');
                        window.location.href = '/favorited_builds/';
                    } else {
                        window.location.href = '/favorited_builds/';
                    }
                }
            };
            xhr.send(JSON.stringify({
                cpu_id: selectedCPUID,
                gpu_id: selectedGPUID,
                mboard_id: selectedMotherboardID,
                ram_id: selectedRAMID,
                psu_id: selectedPSUID,
                storage_id: selectedStorageID,
                case_id: selectedCaseID
            }));
        } else {
            alert('Please select all components before saving!');
        }
    }

    function addToCart() {
        const selectedCPUID = localStorage.getItem('selectedCPUID');
        const selectedGPUID = localStorage.getItem('selectedGPUID');
        const selectedMotherboardID = localStorage.getItem('selectedMotherboardID');
        const selectedRAMID = localStorage.getItem('selectedRAMID');
        const selectedPSUID = localStorage.getItem('selectedPSUID');
        const selectedStorageID = localStorage.getItem('selectedStorageID');
        const selectedCaseID = localStorage.getItem('selectedCaseID');

        if (selectedCPUID && selectedGPUID && selectedMotherboardID && selectedRAMID && selectedPSUID && selectedStorageID && selectedCaseID) {
            // Send selected component IDs to Django view
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/add_to_cart/', true);
            xhr.setRequestHeader('X-CSRFToken', csrftoken);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            alert('PC Build added to cart successfully!');
                            window.location.href = '/cart_items/';
                        } else {
                            alert('Incompatible Components Detected: CPU & Motherboard!');
                        }
                    } else {
                        alert('Request failed with status: ' + xhr.status);
                    }
                }
            };

            xhr.onerror = function () {
                alert('Request error occurred');
            };

            xhr.send(JSON.stringify({
                cpu_id: selectedCPUID,
                gpu_id: selectedGPUID,
                mboard_id: selectedMotherboardID,
                ram_id: selectedRAMID,
                psu_id: selectedPSUID,
                storage_id: selectedStorageID,
                case_id: selectedCaseID
            }));
        } else {
            alert('Please select all components before adding to cart!');
        }
    }

</script>